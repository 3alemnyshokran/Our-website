<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Progress Dashboard</title>
    <link rel="stylesheet" href="../../assets/css/styles.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .progress-overview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .language-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .language-card:hover {
            transform: translateY(-5px);
        }

        .language-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .language-title {
            font-size: 1.5rem;
            margin: 0;
        }

        .progress-bar-container {
            height: 10px;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            border-radius: 5px;
            margin: 15px 0;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 5px;
            transition: width 1s ease-in-out;
        }

        .language-stats {
            display: flex;
            justify-content: space-between;
        }

        .level-list {
            margin-top: 15px;
        }

        .level-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(var(--text-color-rgb), 0.1);
        }

        .level-name {
            font-weight: 500;
        }

        .streak-container {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .streak-icon {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .streak-info h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .day-boxes {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .day-box {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            background-color: rgba(var(--primary-color-rgb), 0.1);
        }

        .day-active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        .recent-activity {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .activity-list {
            list-style-type: none;
            padding: 0;
        }

        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid rgba(var(--text-color-rgb), 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon i {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .activity-content {
            flex-grow: 1;
        }

        .activity-date {
            font-size: 0.8rem;
            color: rgba(var(--text-color-rgb), 0.6);
        }

        .recommendations {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: rgba(var(--text-color-rgb), 0.6);
        }

        .login-prompt {
            text-align: center;
            padding: 40px 20px;
            background: var(--card-bg);
            border-radius: 12px;
            max-width: 600px;
            margin: 100px auto;
        }

        .login-prompt h2 {
            margin-bottom: 20px;
        }

        .login-prompt .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .login-prompt .btn {
            padding: 10px 20px;
        }
        
        .achievements-preview {
            margin-top: 15px;
            border-top: 1px solid rgba(var(--text-color-rgb), 0.1);
            padding-top: 10px;
        }
        
        .achievements-preview h4 {
            font-size: 1rem;
            margin: 0 0 10px 0;
        }
        
        .achievement-icons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .mini-achievement {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(var(--primary-color-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .mini-achievement:hover {
            transform: scale(1.1);
            background-color: rgba(var(--primary-color-rgb), 0.2);
        }
        
        .view-all {
            font-size: 0.8rem;
            color: var(--primary-color);
            text-decoration: none;
            margin-left: auto;
        }

        @media (max-width: 768px) {
            .progress-overview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="logo">
                <a href="../../index.html">PolyglotPro</a>
            </div>
            <ul class="nav-links">
                <li><a href="../../index.html" data-i18n="home">Home</a></li>
                <li><a href="../courses/english/english-course.html" data-i18n="courses">Courses</a></li>
                <li class="active"><a href="../profile/progress-dashboard.html" data-i18n="progress">Progress</a></li>
                <li><a href="../auth/login.html" id="loginBtn" data-i18n="login">Login</a></li>
            </ul>
            <div class="language-switcher">
                <select id="languageSelect" aria-label="Select language">
                    <option value="en">English</option>
                    <option value="es">Espa√±ol</option>
                    <option value="de">Deutsch</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
            </div>
            <button class="theme-btn" aria-label="Toggle dark mode">
                <span class="light-icon">‚òÄÔ∏è</span>
                <span class="dark-icon">üåô</span>
            </button>
            <button class="burger" aria-label="Toggle menu">
                <div class="line1"></div>
                <div class="line2"></div>
                <div class="line3"></div>
            </button>
        </nav>
    </header>

    <main>
        <div id="loginPrompt" class="login-prompt">
            <h2 data-i18n="loginRequired">Login Required</h2>
            <p data-i18n="progressLoginMessage">Please log in to view your learning progress across all languages and levels.</p>
            <div class="button-group">
                <a href="../auth/login.html" class="btn" data-i18n="login">Login</a>
                <a href="../auth/register.html" class="btn" data-i18n="register">Register</a>
            </div>
        </div>

        <div id="dashboardContent" class="dashboard-container" style="display: none;">
            <div class="dashboard-header">
                <h1 data-i18n="progressDashboard">Your Learning Progress</h1>
                <div>
                    <button id="refreshBtn" class="btn">
                        <span data-i18n="refresh">Refresh</span>
                    </button>
                </div>
            </div>

            <div class="streak-container">
                <div class="streak-icon">üî•</div>
                <div class="streak-info">
                    <h3 data-i18n="learningStreak">Learning Streak</h3>
                    <p><span id="streakCount">0</span> <span data-i18n="days">days</span></p>
                    <div class="day-boxes" id="streakDays">
                        <!-- Will be filled dynamically -->
                    </div>
                </div>
            </div>

            <h2 data-i18n="languageProgress">Language Progress</h2>
            <div id="progressOverview" class="progress-overview">
                <!-- Will be filled dynamically -->
                <div class="no-data" id="noProgressData">
                    <p data-i18n="noProgressYet">You haven't started any courses yet. Explore our courses to begin your learning journey!</p>
                </div>
            </div>

            <div class="recent-activity">
                <h2 data-i18n="recentActivity">Recent Activity</h2>
                <ul class="activity-list" id="activityList">
                    <!-- Will be filled dynamically -->
                    <li class="no-data" id="noActivityData">
                        <p data-i18n="noActivityYet">No recent activity. Start learning to track your progress!</p>
                    </li>
                </ul>
            </div>

            <div class="recommendations">
                <h2 data-i18n="recommendations">Recommended Next Steps</h2>
                <div id="recommendationsList">
                    <!-- Will be filled dynamically -->
                    <div class="no-data" id="noRecommendationsData">
                        <p data-i18n="noRecommendationsYet">Complete some lessons to get personalized recommendations!</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">PolyglotPro</div>
            <p>&copy; 2025 PolyglotPro Learning Platform. All rights reserved.</p>
            <div class="footer-links">
                <a href="#" data-i18n="privacy">Privacy Policy</a>
                <a href="#" data-i18n="terms">Terms of Service</a>
                <a href="#" data-i18n="contact">Contact Us</a>
            </div>
        </div>
    </footer>

    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/tracking.js"></script>
    <script>
        // Check if user is logged in
        document.addEventListener('DOMContentLoaded', function() {
            const username = localStorage.getItem('tutor_username');
            const loginPrompt = document.getElementById('loginPrompt');
            const dashboardContent = document.getElementById('dashboardContent');
            const loginBtn = document.getElementById('loginBtn');
            
            if (username) {
                loginPrompt.style.display = 'none';
                dashboardContent.style.display = 'block';
                loginBtn.textContent = 'Logout';
                loginBtn.href = '#';
                loginBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    localStorage.removeItem('tutor_username');
                    localStorage.removeItem('tutor_password');
                    window.location.reload();
                });
                
                // Load user progress
                loadUserProgress();
            } else {
                loginPrompt.style.display = 'block';
                dashboardContent.style.display = 'none';
            }
            
            // Set up refresh button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                loadUserProgress();
            });
        });
        
        function loadUserProgress() {
            const progressOverview = document.getElementById('progressOverview');
            const noProgressData = document.getElementById('noProgressData');
            const activityList = document.getElementById('activityList');
            const noActivityData = document.getElementById('noActivityData');
            const recommendationsList = document.getElementById('recommendationsList');
            const noRecommendationsData = document.getElementById('noRecommendationsData');
            
            // Get all progress data
            const allProgress = UserTracking.getAllProgress();
            
            // Check if there's any progress data
            if (Object.keys(allProgress).length === 0) {
                noProgressData.style.display = 'block';
                noActivityData.style.display = 'block';
                noRecommendationsData.style.display = 'block';
                return;
            }
            
            // We have data, hide the "no data" messages
            noProgressData.style.display = 'none';
            
            // Clear existing content
            progressOverview.innerHTML = '';
            
            // Array to store activities for sorting
            const allActivities = [];
            
            // Process each language
            for (const language in allProgress) {
                const langData = allProgress[language];
                
                // Calculate overall progress for the language
                const langProgress = UserTracking.calculateLanguageProgress(language);
                
                // Create language card
                const languageCard = document.createElement('div');
                languageCard.className = 'language-card';
                
                // Capitalize first letter of language
                const displayLanguage = language.charAt(0).toUpperCase() + language.slice(1);
                
                // Format language label and add flag icon based on language
                let languageIcon = '';
                switch (language) {
                    case 'english':
                        languageIcon = 'üá¨üáß';
                        break;
                    case 'german':
                        languageIcon = 'üá©üá™';
                        break;
                    case 'arabic':
                        languageIcon = 'üá¶üá™';
                        break;
                    case 'math':
                        languageIcon = 'üî¢';
                        break;
                    case 'science':
                        languageIcon = 'üî¨';
                        break;
                    default:
                        languageIcon = 'üìö';
                }
                  // Get language-specific achievements
                const earnedAchievements = UserTracking.getEarnedAchievements()
                    .filter(achievement => achievement.id.startsWith(language.toLowerCase() + '_'))
                    .slice(0, 3); // Limit to 3 achievements per language
                
                // Add language content
                languageCard.innerHTML = `
                    <div class="language-header">
                        <h3 class="language-title">${languageIcon} ${displayLanguage}</h3>
                        <span class="progress-percent">${langProgress}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${langProgress}%"></div>
                    </div>
                    <div class="language-stats">
                        <span>${Object.keys(langData.levels).length} levels</span>
                        <span>Last active: ${formatDate(langData.lastAccessed)}</span>
                    </div>
                    ${earnedAchievements.length > 0 ? `
                    <div class="achievements-preview">
                        <h4>Recent Achievements</h4>
                        <div class="achievement-icons">
                            ${earnedAchievements.map(a => `
                                <div class="mini-achievement" title="${a.name}">
                                    <span>${a.icon}</span>
                                </div>
                            `).join('')}
                            ${earnedAchievements.length > 0 ? `
                                <a href="achievements.html" class="view-all">View All</a>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                    <div class="level-list">
                `;
                
                // Add level details
                for (const level in langData.levels) {
                    const levelData = langData.levels[level];
                    const levelProgress = levelData.progress || 0;
                    const levelName = formatLevelName(level);
                    
                    languageCard.innerHTML += `
                        <div class="level-item">
                            <span class="level-name">${levelName}</span>
                            <div>
                                <span class="level-progress">${levelProgress}%</span>
                                <a href="../../pages/courses/${language}/${language}-course.html#${level}" class="btn btn-small">Continue</a>
                            </div>
                        </div>
                    `;
                    
                    // Add activities
                    for (const chapterId in levelData.chapters) {
                        const chapterData = levelData.chapters[chapterId];
                        
                        // Add to activity list
                        allActivities.push({
                            type: chapterData.completed ? 'complete' : 'visit',
                            language: language,
                            level: level,
                            chapterId: chapterId,
                            date: new Date(chapterData.lastVisit),
                            formattedDate: formatDate(chapterData.lastVisit)
                        });
                    }
                }
                
                languageCard.innerHTML += `</div>`;
                progressOverview.appendChild(languageCard);
            }
            
            // Sort activities to show the most recent first
            allActivities.sort((a, b) => b.date - a.date);
            
            // Update activity list
            updateActivityList(allActivities);
            
            // Generate recommendations
            generateRecommendations(allProgress, allActivities);
            
            // Update streak
            updateStreak(allActivities);
        }
        
        // Format level name for display
        function formatLevelName(level) {
            if (level.startsWith('a') || level.startsWith('b') || level.startsWith('c')) {
                // Format CEFR levels like A1, B2, etc.
                return level.charAt(0).toUpperCase() + level.slice(1);
            } else if (level === 'beginner') {
                return 'Beginner';
            } else if (level === 'intermediate') {
                return 'Intermediate';
            } else if (level === 'advanced') {
                return 'Advanced';
            } else {
                // If it's just a simple level number or other format
                return level.charAt(0).toUpperCase() + level.slice(1);
            }
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        // Update activity list
        function updateActivityList(activities) {
            const activityList = document.getElementById('activityList');
            const noActivityData = document.getElementById('noActivityData');
            
            if (activities.length === 0) {
                noActivityData.style.display = 'block';
                return;
            }
            
            // We have activities, hide the "no activities" message
            noActivityData.style.display = 'none';
            
            // Clear existing list
            activityList.innerHTML = '';
            
            // Show only the most recent 10 activities
            const recentActivities = activities.slice(0, 10);
            
            for (const activity of recentActivities) {
                const li = document.createElement('li');
                li.className = 'activity-item';
                
                const displayLanguage = activity.language.charAt(0).toUpperCase() + activity.language.slice(1);
                const levelName = formatLevelName(activity.level);
                const chapterName = formatChapterName(activity.chapterId);
                
                const icon = activity.type === 'complete' ? '‚úÖ' : 'üëÅÔ∏è';
                const actionText = activity.type === 'complete' ? 'Completed' : 'Viewed';
                
                li.innerHTML = `
                    <div class="activity-icon">
                        <span>${icon}</span>
                    </div>
                    <div class="activity-content">
                        <div>${actionText} <strong>${chapterName}</strong> in ${displayLanguage} (${levelName})</div>
                        <div class="activity-date">${activity.formattedDate}</div>
                    </div>
                `;
                
                activityList.appendChild(li);
            }
        }
        
        // Format chapter name for display
        function formatChapterName(chapterId) {
            // Remove file extension
            const nameWithoutExt = chapterId.replace('.html', '');
            
            // Replace hyphens with spaces
            const nameWithSpaces = nameWithoutExt.replace(/-/g, ' ');
            
            // Capitalize each word
            return nameWithSpaces
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
        
        // Generate personalized recommendations
        function generateRecommendations(progress, activities) {
            const recommendationsList = document.getElementById('recommendationsList');
            const noRecommendationsData = document.getElementById('noRecommendationsData');
            
            if (activities.length === 0) {
                noRecommendationsData.style.display = 'block';
                return;
            }
            
            // We have data for recommendations
            noRecommendationsData.style.display = 'none';
            
            // Clear existing recommendations
            recommendationsList.innerHTML = '';
            
            // Find incomplete levels
            const incompleteLanguages = [];
            
            for (const language in progress) {
                const langData = progress[language];
                
                for (const level in langData.levels) {
                    const levelData = langData.levels[level];
                    
                    // If level progress is less than 100%, it's incomplete
                    if ((levelData.progress || 0) < 100) {
                        incompleteLanguages.push({
                            language,
                            level,
                            progress: levelData.progress || 0,
                            lastAccessed: new Date(levelData.lastAccessed)
                        });
                    }
                }
            }
            
            // Sort by last accessed (most recent first)
            incompleteLanguages.sort((a, b) => b.lastAccessed - a.lastAccessed);
            
            // Generate recommendations HTML
            let recommendationsHTML = '';
            
            // First recommendation: continue where you left off (most recent)
            if (incompleteLanguages.length > 0) {
                const mostRecent = incompleteLanguages[0];
                const displayLanguage = mostRecent.language.charAt(0).toUpperCase() + mostRecent.language.slice(1);
                const levelName = formatLevelName(mostRecent.level);
                
                recommendationsHTML += `
                    <div class="recommendation-item">
                        <h3>Continue where you left off</h3>
                        <p>You're at ${mostRecent.progress}% in ${displayLanguage} ${levelName}.</p>
                        <a href="../../pages/courses/${mostRecent.language}/${mostRecent.language}-course.html#${mostRecent.level}" class="btn">Continue Learning</a>
                    </div>
                `;
            }
            
            // Second recommendation: try a new language if they're only studying one
            const uniqueLanguages = [...new Set(Object.keys(progress))];
            if (uniqueLanguages.length < 3) {
                // Suggest languages they're not learning
                const allLanguages = ['english', 'german', 'arabic', 'math', 'science'];
                const notLearning = allLanguages.filter(lang => !uniqueLanguages.includes(lang));
                
                if (notLearning.length > 0) {
                    // Pick a random language to suggest
                    const suggestedLang = notLearning[Math.floor(Math.random() * notLearning.length)];
                    const displayLanguage = suggestedLang.charAt(0).toUpperCase() + suggestedLang.slice(1);
                    
                    recommendationsHTML += `
                        <div class="recommendation-item">
                            <h3>Try something new</h3>
                            <p>Expand your knowledge by starting ${displayLanguage} courses!</p>
                            <a href="../../pages/courses/${suggestedLang}/${suggestedLang}-course.html" class="btn">Explore ${displayLanguage}</a>
                        </div>
                    `;
                }
            }
            
            // Third recommendation: Take a placement test
            recommendationsHTML += `
                <div class="recommendation-item">
                    <h3>Test your knowledge</h3>
                    <p>Find out your current level with our placement tests.</p>
                    <a href="../../pages/tests/placement-test.html" class="btn">Take Placement Test</a>
                </div>
            `;
            
            recommendationsList.innerHTML = recommendationsHTML;
        }
        
        // Update learning streak
        function updateStreak(activities) {
            const streakCount = document.getElementById('streakCount');
            const streakDays = document.getElementById('streakDays');
            
            // No activities, no streak
            if (activities.length === 0) {
                streakCount.textContent = '0';
                updateStreakDays(0);
                return;
            }
            
            // Group activities by day
            const activityDays = new Map();
            
            for (const activity of activities) {
                const date = new Date(activity.date);
                const dateKey = `${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`;
                
                if (!activityDays.has(dateKey)) {
                    activityDays.set(dateKey, true);
                }
            }
            
            // Calculate streak
            let currentStreak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Check if there was activity today
            const todayKey = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
            let checkDate = new Date(today);
            
            // If no activity today, start checking from yesterday
            if (!activityDays.has(todayKey)) {
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            // Count consecutive days with activity
            let consecutiveDays = true;
            while (consecutiveDays) {
                const dateKey = `${checkDate.getFullYear()}-${checkDate.getMonth()+1}-${checkDate.getDate()}`;
                
                if (activityDays.has(dateKey)) {
                    currentStreak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    consecutiveDays = false;
                }
            }
            
            streakCount.textContent = currentStreak.toString();
            updateStreakDays(currentStreak);
        }
        
        // Update streak day boxes
        function updateStreakDays(streakCount) {
            const streakDays = document.getElementById('streakDays');
            streakDays.innerHTML = '';
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Create 7 day boxes (for the last week)
            for (let i = 6; i >= 0; i--) {
                const day = new Date(today);
                day.setDate(day.getDate() - i);
                
                const dayBox = document.createElement('div');
                dayBox.className = 'day-box';
                
                if (i < streakCount) {
                    dayBox.classList.add('day-active');
                }
                
                // Show day initial (M, T, W, etc.)
                const dayInitial = day.toLocaleDateString('en-US', { weekday: 'short' })[0];
                dayBox.textContent = dayInitial;
                
                streakDays.appendChild(dayBox);
            }
        }
    </script>
</body>
</html>
